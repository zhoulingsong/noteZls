## 方案

* **软件方案：**LVS、Nginx、HAProxy
* **硬件方案：**F5 



## 一、LVS

~~~
全称 Linux Virtual Server，工作在 OSI 模型的第四层——传输层之上，支持 TCP/UDP 的负载均衡。相对于其它高层负载均衡效率更高，比如 DNS 域名轮流解析、应用层负载的调度、客户端的调度等。
适应范围：大型网站或重要的服务，且服务器比较多时。
~~~

#### 工作模式

* **NAT 模式：**网络地址转换，修改 IP 地址，分为源地址修改 SNAT 和目标地址修改 DNAT。LVS 需要作为 RS（真实服务器）的网关。客户端发包到达 LVS 时，LVS 进行 DNAT，将目标 IP 改为 RS 的 IP。RS 返回响应时，源 IP 是 RS 的 IP，目标 IP 是客户端的 IP。LVS 进行 SNAT，将源 IP 改为 客户端的 IP。

* **DR 模式：**直接路由，修改目标 MAC 地址。LVS 和 RS 集群绑定同一个 VIP（RS 通过将 VIP 绑定在 loopback 实现），请求由 LVS 接收，但由 RS（真实服务器 RealServer）直接返回给用户不经过 LVS。
  LVS 只需要将网络帧的 MAC 地址修改为某一台 RS 的 MAC，该包就会被转发到相应的 RS 处理，注意此时的源 IP 和目标 IP 都没变。RS 收到 LVS 转发来的包时，链路层发现 MAC 是自己的，到上面的网络层，发现 IP 也是自己的，于是这个包被合法地接受，RS 感知不到前面有 LVS 的存在。而当 RS 返回响应时，直接返回，不再经过 LVS。

  ~~~
  比较：
  	DR 负载均衡模式数据分发过程中不修改 IP 地址，只修改 mac 地址，由于实际处理请求的真实物理 IP 地址和数据请求目的 IP 地址一致，所以不需要通过负载均衡服务器进行地址转换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈。因此，DR 模式具有较好的性能，也是目前大型网站使用最广泛的一种负载均衡手段。
  ~~~



#### 优点：

* 抗负载能力强、工作在传输层上仅作分发之用，没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的，对内存和 cpu 资源消耗比较低。
* 配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率。
* 工作稳定，因为其本身抗负载能力很强，自身有完整的双机热备方案，如 LVS + Keepalived。
* 无流量，LVS 只分发请求，而流量并不从它本身出去，保证了均衡器 IO 的性能不会受到大流量的影响。
* 应用范围比较广，因为 LVS 工作在传输层，几乎可以对所有应用做负载均衡，包括 http、数据库、在线聊天室等等。

#### 缺点：

* 软件本身不支持正则表达式处理，不能做动静分离；而现在许多网站在这方面都有较强的需求，这个是 Nginx、HAProxy + Keepalived 的优势所在。
* 如果是网站应用比较庞大的话，LVS/DR + Keepalived 实施起来就比较复杂了，相对而言，Nginx / HAProxy + Keepalived 就简单多了。
* 需要机器较多



## 二、Nginx

~~~
Nginx 是一个强大的 Web 服务器软件，用于处理高并发的 HTTP 请求和作为反向代理服务器做负载均衡。具有高性能、轻量级、内存消耗少，强大的负载均衡能力等优势。

架构设计：采用模块化的、基于事件驱动、异步、单线程且非阻塞。

适应范围：中小型的 Web 应用，比如日 PV 小于1000万，多台机器可通过DNS轮询，在DNS服务器上对一个域名设置多个ip解析，每一个ip对应的是一个Ng，可以增加入口的Nginx实例个数，起到水平扩容的作用，解决反向代理层的扩展问题。
~~~

#### 负载均衡策略

- 轮询（默认）：每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器 down 掉，能自动剔除。
- weight：权重，指定轮询几率，weight 和访问比率成正比，用于后端服务器性能不均的情况。
- 最少连接：least_conn;
- ip_hash：每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题。
- fair（第三方）：按后端服务器的响应时间来分配请求，响应时间短的优先分配。
- url_hash（第三方）：按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，后端服务器为缓存时比较有效。



#### 优点：

* 跨平台，Nginx 可以在大多数 Unix like OS编译运行，而且也有 Windows 的移植版本；
* 配置异常简单：非常容易上手。配置风格跟程序开发一样，神一般的配置；
* 非阻塞、高并发连接：官方测试能够支撑5万并发连接，在实际生产环境中跑到2～3万并发连接数；
* 事件驱动：通信机制采用 epoll 模型，支持更大的并发连接；
* Master/Worker 结构：一个 master 进程，生成一个或多个 worker 进程；
* 内存消耗小：处理大并发的请求内存消耗非常小。在3万并发连接下，开启的10个 Nginx 进程才消耗150M 内存（15M*10=150M）；
* 内置的健康检查功能：如果 Nginx 代理的后端的某台 Web 服务器宕机了，不会影响前端访问；
* 节省带宽：支持 GZIP 压缩，可以添加浏览器本地缓存的 Header 头；
* 稳定性高：用于反向代理，宕机的概率微乎其微；

#### 

####缺点：

* 仅能支 持http、https 、tcp、 Email等协议，适用范围小；
* 对后端服务器的健康检查，只支持通过端口来检测，不支持通过 ur l来检测。不支持 Session 的直接保持，但能通过 ip_hash 来解决；



## 三、HAProxy

~~~
适应范围：

HAProxy 支持两种代理模式 TCP（四层）和HTTP（七层），也是支持虚拟主机的。

HAProxy 的优点能够补充 Nginx 的一些缺点，比如支持 Session 的保持，Cookie 的引导；同时支持通过获取指定的 url 来检测后端服务器的状态。

HAProxy 跟 LVS 类似，本身就只是一款负载均衡软件；单纯从效率上来讲 HAProxy 会比 Nginx 有更出色的负载均衡速度，在并发处理上也是优于 Nginx 的。

HAProxy 支持 TCP 协议的负载均衡转发，可以对 MySQL 读进行负载均衡，对后端的 MySQL 节点进行检测和负载均衡，大家可以用 LVS+Keepalived 对 MySQL 主从做负载均衡。
~~~

#### 负载均衡策略

* Round-robin（轮循）
* Weight-round-robin（带权轮循）
* source（原地址保持）
* RI（请求URL）
* rdp-cookie（根据cookie）。