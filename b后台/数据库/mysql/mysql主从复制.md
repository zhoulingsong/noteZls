~~~
https://baijiahao.baidu.com/s?id=1617888740370098866&wfr=spider&for=pc
默认为异步方式。
要实施复制，首先必须打开Master 端的binary log（bin-log）功能，否则无法实现。

因为整个复制过程实际上就是Slave 从Master 端获取该日志然后再在自己身上完全顺序的执行日志中所记录的各种操作


~~~



一主一从：注备实现高可用，读写分离。

一主多从：提高读性能。

多主一从：备份特重要数据（5.7开始支持）



双主复制：互为主从。

级联复制：多级从节点。



### 用途

* 读写分离。
* 备份，高可用。
* 架构扩展。



## 原理

* **主节点 binary log dump 线程**

  ~~~ 
  主节点：当有从节点连接时，创建一个log dump 线程，用于发送bin-log的内容。多个从节点连接，则创建多个线程。在读取bin-log中的操作时，此线程会对主节点上的bin-log加锁，当读取完成，甚至在发动给从节点之前，锁会被释放。
  ~~~

* **从节点I/O线程**

  ~~~
  从节点：当执行 start slave 命令之后，创建一个 I/O 线程来连接主节点，请求主库中更新的bin-log。I/O线程接收到主节点binlog dump 进程发来的更新之后，保存在本地relay-log中。
  ~~~

* **从节点SQL线程**

  ~~~
  从节点：SQL线程负责读取relay log中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。
  ~~~

~~~
备注：从节点用两个线程将从主库拉取更新和执行分成独立的任务，这样在执行同步数据任务的时候，不会降低读操作的性能。比如，如果从节点没有运行，此时I/O进程可以很快从主节点获取更新，尽管SQL进程还没有执行。如果在SQL进程执行之前从节点服务停止，至少I/O进程已经从主节点拉取到了最新的变更并且保存在本地relay日志中，当服务再次起来之后，就可以完成数据的同步。

步奏：
从节点上的I/O 进程连接主节点，并请求从指定日志文件的指定位置（或者从最开始的日志）之后的日志内容；
主节点接收到来自从节点的I/O请求后，通过负责复制的I/O进程根据请求信息读取指定日志指定位置之后的日志信息，返回给从节点。返回信息中除了日志所包含的信息之外，还包括本次返回的信息的bin-log file 的以及bin-log position；从节点的I/O进程接收到内容后，将接收到的日志内容更新到本机的relay log中，并将读取到的binary log文件名和位置保存到master-info 文件中，以便在下一次读取的时候能够清楚的告诉Master“我需要从某个bin-log 的哪个位置开始往后的日志内容，请发给我”；
Slave 的 SQL线程检测到relay-log 中新增加了内容后，会将relay-log的内容解析成在祝节点上实际执行过的操作，并在本数据库中执行。
~~~



## 模式

* **异步（async-mode）**

  ~~~
  默认模式，
  主节点不主动同步给从节点，
  ~~~

* **半同步（semi-sync）**

  ~~~
  主节点只需要接收到其中一台从节点的返回信息，就会commit事务；否则需要等待直到超时时间然后切换成异步模式再提交；这样做的目的可以使主从数据库的数据延迟缩小，可以提高数据安全性，确保了事务提交后，binlog至少传输到了一个从节点上，不能保证从节点将此事务更新到db中。性能上会有一定的降低，响应时间会变长。
  ~~~

  